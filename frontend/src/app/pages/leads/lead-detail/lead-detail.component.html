<app-navbar></app-navbar>

<div class="page-container">
  <div class="lead-detail">
    <div class="lead-form card">
      <h3>{{ isEditMode ? 'Edit Lead' : 'New Lead' }}</h3>

      <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>
        <div class="row">
          <mat-form-field appearance="outline">
            <mat-label>First name</mat-label>
            <input matInput formControlName="firstName" />
            <mat-error *ngIf="form.controls.firstName.invalid && form.controls.firstName.touched">
              First name is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Last name</mat-label>
            <input matInput formControlName="lastName" />
            <mat-error *ngIf="form.controls.lastName.invalid && form.controls.lastName.touched">
              Last name is required
            </mat-error>
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="full">
          <mat-label>Email</mat-label>
          <input matInput formControlName="email" />
          <mat-error *ngIf="form.controls.email.invalid && form.controls.email.touched">
            Provide a valid email
          </mat-error>
        </mat-form-field>

        <div class="selects">
          <mat-form-field appearance="outline">
            <mat-label>Source</mat-label>
            <mat-select formControlName="source">
              <mat-option *ngFor="let s of leadSources" [value]="s.value">{{ s.label }}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Status</mat-label>
            <mat-select formControlName="status">
              <mat-option *ngFor="let s of leadStatuses" [value]="s.value">{{
                s.label
              }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="actions">
          <button mat-button type="button" (click)="close()">Cancel</button>
          <button
            mat-flat-button
            color="primary"
            type="submit"
            [disabled]="isSubmitting || form.invalid"
          >
            {{ isEditMode ? 'Save' : 'Create' }}
          </button>
        </div>
      </form>
    </div>

    <hr />

    <div class="lead-tasks card">
      <div class="tasks-header">
        <h4>Tasks</h4>
        <button mat-flat-button color="primary" (click)="openAddTask()">+ Add Task</button>
      </div>

      <div *ngIf="tasksLoading" class="tasks-loading">
        <mat-progress-spinner diameter="24" mode="indeterminate"></mat-progress-spinner>
        <span>Loading tasks...</span>
      </div>

      <div *ngIf="!tasksLoading && tasks.length === 0" class="empty">No tasks for this lead.</div>

      <div *ngIf="!tasksLoading && tasks.length > 0" class="tasks-list">
        <div *ngFor="let t of tasks" class="task-row" tabindex="0">
          <div class="task-main">
            <div>
              <div class="task-title">{{ t.title }}</div>
              <div class="task-meta">{{ t.dueDate | date : 'shortDate' }} â€¢ {{ t.priority }}</div>
            </div>

            <div class="task-actions" (click)="$event.stopPropagation()">
              <button mat-icon-button (click)="editTask(t)" aria-label="Edit task">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="deleteTask(t)" aria-label="Delete task">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="showTaskForm" class="task-form-wrap">
        <app-task-form
          [task]="editingTask"
          [leadId]="leadId"
          (saved)="onTaskSaved($event)"
          (cancelled)="onTaskCancelled()"
        ></app-task-form>
      </div>
    </div>
  </div>
</div>
